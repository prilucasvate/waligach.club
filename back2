<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">

  <meta charset="UTF-8">
  <title>抽!!!</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      min-height: 100vh;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      /*background: radial-gradient(120deg, 	#d2f1ff 0%, #ffffff 100%);*/
      
      background-image: 
        radial-gradient(farthest-corner at 90% 65%, #f289a5c3, rgba(239, 142, 219, 0.59), rgba(254, 254, 254, 0.727), transparent 90%),
        radial-gradient(farthest-corner at 5% 5%, rgba(207, 75, 251, 0.604), #ffffffbc, transparent 75%),
        radial-gradient(farthest-corner at 5% 80%, rgba(218, 225, 12, 0.826),transparent 50%),
        radial-gradient(farthest-corner at 70% 20%, 	#2bb3f7c7 0%, #ffffff9f 100%); 
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: 100% 100%;
      box-sizing: border-box;
      font-family: sans-serif;

    }
    
    img {
      width: 100%;
      max-width: 330px;   /* 圖片在手機上自動縮小 */
      height: auto;
      max-height: 220px; /* 或視覺上覺得最適合的高度 */
      object-fit: contain;
      display: block;         /*  讓圖片可 margin: auto */
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      margin: auto;
    }
    h1 {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      font-size: 66px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      background: linear-gradient(to right, #f581b5, #ff65a3, #6cecee);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.2);
      animation: fadeInUp 1s ease-out;
    }
    h2 {
      font-size: 24px;
      font-weight: 700;
      border-bottom: 3px solid #dd9de1;
      padding-bottom: 4px;
      margin-top: 28px;
      margin-bottom: 12px;
    }
    h2.gradient-title {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #4c3855, #738026);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    #optionList {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
    
    input, button {
      font-size: 24px;
      padding: 14px;
      margin: 6px 4px;
      width: 100%;         /* 滿版按鈕與輸入框 */
      box-sizing: border-box;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: none;
    }
    .container {
      width: 100%;
      max-width: 800px;
      box-sizing: border-box;
      padding: 14px 24px;
      margin: 20px auto;
      background: rgba(255, 255, 255, 0.45);                 /* 白色背景讓卡片浮起來 */
      border-radius: 20px;               /* 圓角 */
      box-shadow: 0 8px 16px rgba(0,0,0,0.15); /* 陰影 */
    }
    .option-item{
      /* ① 三欄版型：編號 / 文字 / 刪除 */
      display:grid;
      grid-template-columns: minmax(3ch,4.5ch) 1fr 46px;
      /* ^ 左欄最小 3ch，最大 4.5ch；右欄固定 46px，剩下給文字 */
      align-items:start;          /* 編號 & X 與文字頂齊 */
      column-gap:12px;           /* 欄間距 */
      padding:4px 0;             /* 上下小留白 */
      font-size:32px;            /* 列文字大小 */
      line-height:1.35;          /* 行高略緊 */
      width: 700px;
    }

    /* ▼ 編號 */
    .index-label{
      text-align:right;
      font-weight:700;
      white-space:nowrap;        /* 避免 10. 換行 */
      color:#444;
    }

    /* 文字：拿掉 width，讓 1fr 真的撐滿 */
    .option-text{
      word-break:break-word;     /* 長詞斷行 */
      overflow-wrap:anywhere;    /* 再保險一次 */
      font-size:32px;
      letter-spacing:.3px;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      color:#4c3855;
    }
    @media (hover: hover) and (pointer: fine) {
      .fancy-button:hover,
      #mainButton:hover,
      .switch-user-button:hover,
      .delete-btn:hover {
        transform: scale(1.03);
        box-shadow: 0 8px 16px rgba(0,0,0,.15);
      }
    }
    /* ▼ 刪除按鈕：固定寬高、置中 */
    .delete-btn{
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      border-radius:12px;
      background:rgba(255,255,255,.65);
      border:1px solid #f9d1e2;
      color:#ff4f7e;
      cursor:pointer;
      transition:transform .15s;
      opacity: 0.85;              
      transition: opacity 0.2s;
    }
    /* .delete-btn:hover {
      opacity: 1;   
      transform: scale(1.04);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    } */
    .delete-btn:active {
      transform: scale(0.95);
    }
    .fancy-button {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      border: none;
      border-radius: 999px;
      background: linear-gradient(to right, #ee7ba3, #eb9ab6);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      animation: fadeInUp 1s ease-out forwards;
    }
    /* .fancy-button:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    } */
    .fancy-button:active {
      transform: scale(0.97);
    }

    .modal-backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      padding: 32px 24px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 320px;
      width: 90%;
      animation: popIn 0.5s ease-out;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
    }
    .modal-box h2 {
      margin-bottom: 10px;
      font-size: 24px;
    }
    .modal-box input {
      padding: 10px;
      width: 100%;
      border-radius: 12px;
      border: 1px solid #ccc;
      margin: 12px 0;
      font-size: 16px;
    }
    .modal-box button {
      background: linear-gradient(to right, #f58faf, #ffa8c6);
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 999px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    /* .modal-box button:hover {
      transform: scale(1.05);
    } */
    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    #result {       /* 抽中結果更醒目 */
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      margin: 16px 0;
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      background: linear-gradient(to right, #01ac6d, #5a8608);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(255,255,255,0.4);  
    }
  
    #drawTime {
      color: gray;
      font-size: 16px;
      text-align: center;
      font-family: 'Courier New', monospace;
    }
    #mainButton {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #eb7aa1, #ee97b5); 
      font-size: 30px;
      display: block;              
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 999px;             /* 大圓角 */
      margin: 20px auto;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);  /* 陰影 */
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    /* #mainButton:hover {
      transform: scale(1.03);
    } */
    #mainButton:active {
      transform: scale(0.97);
    }
    #history-area {
      margin-top: 24px;
      background: rgba(255, 255, 255, 0.2);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    #result.error {
      color: #f85951;
      font-weight: bold;
      font-size: 36px;
      text-shadow: none;
    }
    #nameModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.15); /* 淺白透明背景 */
      backdrop-filter: blur(12px);          /* 核心打霧效果 */
      -webkit-backdrop-filter: blur(12px);  /* Safari */
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #online-list {    
      list-style: disc inside; /* 顯示黑點在文字前方 */
      padding-left: 16px;       /* 留一點空間讓黑點能顯示 */
    }
    #online-list li {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      font-size: 22px;
      color: #4c3855;
      font-weight: 500;
      padding: 4px 0;
      width: 100%; 
      margin-left: 8px;
    }
    .history-entry {
      display: grid;
      grid-template-columns: max-content 1fr max-content;
      gap: 8px;
      align-items: start;
      padding: 6px 0;
      font-size: 22px;
      border-bottom: 1px dashed #e3c7e7;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      width: 100%; 
    }

    .user-label {
      color: #555;
      font-weight: 500;
      white-space: nowrap;
    }

    .result-part {
      font-weight: 600;
      color: #333;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .time-part {
      color: #888;
      white-space: nowrap;
      font-family: monospace;
      font-size: 16px;
    }

    .switch-user-button {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #f99ab8, #fbbbce);
      color: white;
      font-weight: bold;
      font-size: 24px;
      border: none;
      border-radius: 999px;
      padding: 14px 28px;
      width: 100%;
      margin: 24px auto;
      display: block;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    /* .switch-user-button:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    } */
    .switch-user-button:active {
      transform: scale(0.97);
    }
    .user-info-area {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-top: 16px;
    }

    .current-user-text {
      margin-top: 6px;
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }
    
    @media (max-width: 480px) {
      h1, h2 {
        font-size: 20px;
        text-align: center;
      }
      .option-item {
        font-size: 18px;
      }
      .delete-btn {
        font-size: 18px;
      }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
      }
    }
    @keyframes pop {
      0%   { transform: scale(0.8); opacity: 0; }
      60%  { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }

    #result.show {
      animation: pop 0.4s ease-out;
    }

    
  </style>
</head>

<body>
  <div id="nameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999;">
    <div style="background: rgba(255, 255, 255, 0.855); padding: 24px 32px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center;">
      <h1 style="margin-bottom: 12px;"> 嗨！你是誰？</h1>
      <input id="nameInput" type="text" placeholder="你叫啥來著" style="padding: 12px; font-size: 18px; width: 100%; border-radius: 8px; border: 1px solid #ccc;">
      <button onclick="saveUserName()" style="margin-top: 16px; padding: 10px 16px; font-size: 20px; border: none;font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; border-radius: 8px; background: #ff85b2; color: white; cursor: pointer;">
        忍不住要進去了 ><
      </button>
    </div>
  </div>
  
  <div class="container">
    <h1>欸要吃什麼？</h1>
    <img src="https://videos.openai.com/vg-assets/assets%2Ftask_01jxgefg9hespvvmy5nh2dy59c%2F1749677590_img_0.webp?st=2025-06-11T19%3A58%3A32Z&se=2025-06-17T20%3A58%3A32Z&sks=b&skt=2025-06-11T19%3A58%3A32Z&ske=2025-06-17T20%3A58%3A32Z&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skoid=8ebb0df1-a278-4e2e-9c20-f2d373479b3a&skv=2019-02-02&sv=2018-11-09&sr=b&sp=r&spr=https%2Chttp&sig=vF8K4iUYNiurQFdGpMH6aIZUcK2lIvVdJdwbwLIYTyw%3D&az=oaivgprodscus" alt="random">
    <br>
    <div>
      <input id="newOption" type="text" placeholder="加個選項">
      <button class="fancy-button" onclick="addOption()">加進選項吧 ~</button>
      <button class="fancy-button" onclick="confirmReset()" >全部重設 !</button>
    </div>

    <h2 class="gradient-title" >目前選項：</h2>
    <ul id="optionList"></ul>
    <button id="mainButton" class="fancy-button" onclick="draw()">幫我選吧 !! </button>
    <p id="loadingText" style="display:none; text-align:center; font-size:24px; color:#888;"></p>
    <h2 id="result" >我來幫你選 ! </h2>
    <p id="drawTime" style="color: gray; font-size: 16px;"></p>
    <div id="history-area" style="margin-top: 20px;">
      <h2 class="gradient-title">抽選紀錄 ( 近五筆 )：</h2>
      <ul id="history-list" style="padding-left: 0;"></ul>
    </div>
    <div class="user-info-area">
      <button  id="resetUserBtn" class="switch-user-button" onclick="resetUser()">更換使用者</button>
      <span id="currentUserDisplay" class="current-user-text"></span>
    </div>
    <div id="online-area" style="margin-top:24px;">
      <h2 class="gradient-title">現在在線  ( <span id="online-count">0</span> )</h2>
      <ul id="online-list" style="padding-left:0;"></ul>
    </div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();     //  一開始就連線
    </script>
    <script>
      
      //---- login user
      // 2.儲存名稱並關閉登入框
      function saveUserName() {
        const nameInput = document.getElementById("nameInput").value.trim();
        if (!nameInput) {
          alert("請輸入名稱！");
          return;
        }
        // localStorage.setItem("userName", nameInput); //先不存 等候端檢查重複
        document.getElementById("resetUserBtn").textContent = `更換使用者（ 泥現在是 ${nameInput} ）`;
        document.getElementById("nameModal").style.display = "none";
        socket.emit("register", nameInput);//3.丟到後面檢查重複 會回復fail or ok
      }
      //4.1 後端回fail
      socket.on("register_failed", data => {//check same name
        alert(data.error);              // 名稱重複
        // localStorage.removeItem("userName");
        document.getElementById("nameModal").style.display = "flex";
        document.getElementById("nameInput").focus();
      });
      //4.2 後端回ok 存
      socket.on("register_ok", username => {   // backend多送這個事件 ok 才存
        localStorage.setItem("userName", username);
        document.getElementById("resetUserBtn").textContent =
            `更換使用者（ 泥現在是 ${username} ）`;
        document.getElementById("nameModal").style.display = "none";
      });

      socket.on("user_list", users => {//list user
        const countEl = document.getElementById("online-count");
        const listEl  = document.getElementById("online-list");
        countEl.textContent = users.length;
        listEl.innerHTML = "";
        users.forEach(name => {
          const li = document.createElement("li");
          li.textContent = name;
          li.style.padding = "4px 0";
          listEl.appendChild(li);
        });
      });
      // 1.網頁載入完成後執行 跳視窗問
      window.addEventListener("DOMContentLoaded", () => {
        const saved = localStorage.getItem("userName");
        if (!saved) {//local 沒存過 等輸入
          document.getElementById("nameModal").style.display = "flex";
        } else {//local 有存過了 直接丟後面檢查
          document.getElementById("resetUserBtn").textContent = `更換使用者（ 泥現在是 ${saved} ）`;
          socket.emit("register", saved); //3.丟到後面檢查重複 會回復fail or ok
        }
        const input = document.getElementById("nameInput");// 讓按下 Enter 可以觸發登入
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            saveUserName(); // 2.透過 saveUserName() 把剛輸入的名字送去後端
          }
        });
      });
      
      //document.getElementById("resetUserBtn").textContent = `更換使用者（ 泥現在是 ${saved} ）`;// 顯示在按鈕上
      // 更換使用者的按鈕
      function resetUser() {
        localStorage.removeItem("userName");
        location.reload(); // 重新整理後 刪之前名字 再重新詢問名字
      }
      //-------------------------
      
      function confirmReset() { //reset warning 
        const confirmed = confirm("確定要清空所有選項嗎？這個動作無法復原！");
        if (confirmed) { 
          reset();  // 呼叫原本的 reset()
        }
      }
      let lastVersion = null;
      const historyList = [];

      async function syncStatus(dataFromCheck = null) {
        const data = dataFromCheck || await (await fetch("/status")).json();

        const resultEl = document.getElementById("result");
        const timeEl = document.getElementById("drawTime");

        resultEl.textContent = data.result ? `抽中：${data.result}` : "我來幫你選 !!";
        timeEl.textContent = data.time ? `抽取時間：${data.time}` : "";

        const list = document.getElementById("optionList");
        list.innerHTML = "";
        (data.options || []).forEach((opt, index) => {
          const li = document.createElement("li");
          li.className = "option-item";

          const idx = document.createElement("span");
          idx.className = "index-label";
          idx.textContent = `${index + 1}.`;

          const span = document.createElement("span");
          span.textContent = opt;
          span.className = "option-text";

          const x = document.createElement("button");
          x.textContent = "❌";
          x.className = "delete-btn";
          x.onclick = async () => {
            await fetch("/remove_option", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ option: opt })
            });
          };

          li.appendChild(idx);
          li.appendChild(span);
          li.appendChild(x);
          list.appendChild(li);
        });

        window.currentOptions = data.options;
      }

      async function addOption() {
        const input = document.getElementById("newOption");
        const value = input.value.trim();
        if (!value) return;
        if ((window.currentOptions || []).includes(value)) {
          alert("慢了 別人填了！");
          input.value = "";
          return;
        }
        await fetch("/add_option", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ option: value })
        });
        input.value = "";
      }

      document.getElementById("newOption").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          addOption();
        }
      });

      async function draw() {
        const userName = localStorage.getItem("userName");//user id

        const resultEl = document.getElementById("result");
        const timeEl = document.getElementById("drawTime");
        const loadingText = document.getElementById("loadingText");
        //precheck isempty no option
        const check = await fetch("/status");
        const dataCheck = await check.json();
        if (!dataCheck.options || dataCheck.options.length === 0) {
          resultEl.textContent = "沒選項你想抽啥 ?";
          resultEl.classList.add("error");  // 加上紅色樣式
          resultEl.style.display = "block";
          return;
        }
        // 顯示 loading 文字，隱藏結果
        resultEl.style.display = "none";
        loadingText.style.display = "block";
        timeEl.textContent = "";
        
        loadingText.textContent = "準備中...";
        const phrases = [
          "選擇困難中 等我...",
          "正在叫吳澤樺起床...",
          "等待別人給我讚賞...",
          "抽完不要又後悔喔...",
          "不覺得這樣很好玩嗎...",
          "拜託給點情緒價值...",
          "好啦真的要抽了 ! ! !"
        ];
        // 輪流更新文字
        loadingIndex = 0;
        loadingTimer = setInterval(() => {
          loadingText.textContent = phrases[loadingIndex % phrases.length];
          loadingIndex++;
        }, 800); 
        // 等秒（模擬抽獎）
        await new Promise(resolve => setTimeout(resolve, 6000));
        //發出請求
        const res = await fetch("/draw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: userName })
        });
        const data = await res.json();
        // 結果顯示
        clearInterval(loadingTimer); // 停止輪播
        loadingText.style.display = "none";
        resultEl.style.display = "block";

        if (data.result) {
          resultEl.textContent = `抽中：${data.result}`;
          timeEl.textContent = `抽取時間：${data.time}`;

          resultEl.classList.remove("show"); // 先移除再重新加
          void resultEl.offsetWidth; // force reflow
          resultEl.classList.add("show");
        } else {
          resultEl.textContent = data.error || "錯誤";
          timeEl.textContent = "";
        }
      }
      

      async function reset() {
        await fetch("/reset_options", { method: "POST" });
      }


      function updateHistoryDisplay() {
        const ul = document.getElementById("history-list");
        ul.innerHTML = ''; // 清空現有內容
        historyList.forEach(item => {
          const li = document.createElement("li");
          li.className = "history-entry";

          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.listStyle = "none";
          const userSpan = document.createElement("span");
          userSpan.className = "user-label";
          userSpan.textContent = `${item.user} 抽中：`;

          const resultSpan = document.createElement("span");
          resultSpan.className = "result-part";
          resultSpan.textContent = item.result;

          const timeSpan = document.createElement("span");
          timeSpan.className = "time-part";
          timeSpan.textContent = `時間：${item.time}`;
          timeSpan.style.color = "gray";
          
          li.appendChild(userSpan);
          li.appendChild(resultSpan);
          li.appendChild(timeSpan);
          ul.appendChild(li);
        });
      }
      
      async function loadHistory() {
      const res = await fetch("/history");
      const data = await res.json();
      historyList.length = 0;
      historyList.push(...data);
      updateHistoryDisplay(); 
      }
      loadHistory();
      syncStatus();


      socket.on("connect", () => {
        console.log("WebSocket 已連線");
      });

      socket.on("history_update", (data) => {
        console.log("收到歷史紀錄更新：", data);
        historyList.length = 0;
        historyList.push(...data);
        updateHistoryDisplay();
      });
      socket.on("status_update", (data) => {
        console.log("收到最新狀態：", data);
        syncStatus(data);  // 直接呼叫原本處理邏輯
      });
    </script>
  </div>
</body>
</html>
