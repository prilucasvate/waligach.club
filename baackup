<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">

  <meta charset="UTF-8">
  <title>æŠ½!!!</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      min-height: 100vh;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      /*background: radial-gradient(120deg, 	#d2f1ff 0%, #ffffff 100%);*/
      
      background-image: 
        radial-gradient(farthest-corner at 90% 65%, #f289a5c3, rgba(239, 142, 219, 0.59), rgba(254, 254, 254, 0.727), transparent 90%),
        radial-gradient(farthest-corner at 5% 5%, rgba(207, 75, 251, 0.604), #ffffffbc, transparent 75%),
        radial-gradient(farthest-corner at 5% 80%, rgba(218, 225, 12, 0.826),transparent 50%),
        radial-gradient(farthest-corner at 70% 20%, 	#2bb3f7c7 0%, #ffffff9f 100%); 
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: 100% 100%;
      box-sizing: border-box;
      font-family: sans-serif;

    }
    
    img {
      width: 100%;
      max-width: 330px;   /* åœ–ç‰‡åœ¨æ‰‹æ©Ÿä¸Šè‡ªå‹•ç¸®å° */
      height: auto;
      max-height: 220px; /* æˆ–è¦–è¦ºä¸Šè¦ºå¾—æœ€é©åˆçš„é«˜åº¦ */
      object-fit: contain;
      display: block;         /*  è®“åœ–ç‰‡å¯ margin: auto */
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      margin: auto;
    }
    h1 {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      font-size: 66px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      background: linear-gradient(to right, #f581b5, #ff65a3, #6cecee);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.2);
      animation: fadeInUp 1s ease-out;
    }
    h2 {
      font-size: 24px;
      font-weight: 700;
      border-bottom: 3px solid #dd9de1;
      padding-bottom: 4px;
      margin-top: 28px;
      margin-bottom: 12px;
    }
    h2.gradient-title {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #4c3855, #738026);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    #optionList {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
    }
    
    input, button {
      font-size: 24px;
      padding: 14px;
      margin: 6px 4px;
      width: 100%;         /* æ»¿ç‰ˆæŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† */
      box-sizing: border-box;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: none;
    }
    .container {
      width: 100%;
      max-width: 800px;
      box-sizing: border-box;
      padding: 14px 24px;
      margin: 20px auto;
      background: rgba(255, 255, 255, 0.45);                 /* ç™½è‰²èƒŒæ™¯è®“å¡ç‰‡æµ®èµ·ä¾† */
      border-radius: 20px;               /* åœ“è§’ */
      box-shadow: 0 8px 16px rgba(0,0,0,0.15); /* é™°å½± */
    }
    .option-item{
      /* â‘  ä¸‰æ¬„ç‰ˆå‹ï¼šç·¨è™Ÿ / æ–‡å­— / åˆªé™¤ */
      display:grid;
      grid-template-columns: minmax(3ch,4.5ch) 1fr 46px;
      /* ^ å·¦æ¬„æœ€å° 3chï¼Œæœ€å¤§ 4.5chï¼›å³æ¬„å›ºå®š 46pxï¼Œå‰©ä¸‹çµ¦æ–‡å­— */
      align-items:start;          /* ç·¨è™Ÿ & X èˆ‡æ–‡å­—é ‚é½Š */
      column-gap:12px;           /* æ¬„é–“è· */
      padding:4px 0;             /* ä¸Šä¸‹å°ç•™ç™½ */
      font-size:32px;            /* åˆ—æ–‡å­—å¤§å° */
      line-height:1.35;          /* è¡Œé«˜ç•¥ç·Š */
      width: 700px;
    }

    /* â–¼ ç·¨è™Ÿ */
    .index-label{
      text-align:right;
      font-weight:700;
      white-space:nowrap;        /* é¿å… 10. æ›è¡Œ */
      color:#444;
    }

    /* æ–‡å­—ï¼šæ‹¿æ‰ widthï¼Œè®“ 1fr çœŸçš„æ’æ»¿ */
    .option-text{
      word-break:break-word;     /* é•·è©æ–·è¡Œ */
      overflow-wrap:anywhere;    /* å†ä¿éšªä¸€æ¬¡ */
      font-size:32px;
      letter-spacing:.3px;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      color:#4c3855;
    }
    @media (hover: hover) and (pointer: fine) {
      .fancy-button:hover,
      #mainButton:hover,
      .switch-user-button:hover,
      .delete-btn:hover {
        transform: scale(1.03);
        box-shadow: 0 8px 16px rgba(0,0,0,.15);
      }
    }
    /* â–¼ åˆªé™¤æŒ‰éˆ•ï¼šå›ºå®šå¯¬é«˜ã€ç½®ä¸­ */
    .delete-btn{
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      border-radius:12px;
      background:rgba(255,255,255,.65);
      border:1px solid #f9d1e2;
      color:#ff4f7e;
      cursor:pointer;
      transition:transform .15s;
      opacity: 0.85;              
      transition: opacity 0.2s;
    }
    /* .delete-btn:hover {
      opacity: 1;   
      transform: scale(1.04);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    } */
    .delete-btn:active {
      transform: scale(0.95);
    }
    .fancy-button {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      border: none;
      border-radius: 999px;
      background: linear-gradient(to right, #ee7ba3, #eb9ab6);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      opacity: 1;
      animation: fadeInUp 1s ease-out forwards;
    }
    /* .fancy-button:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    } */
    .fancy-button:active {
      transform: scale(0.97);
    }

    .modal-backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      padding: 32px 24px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 320px;
      width: 90%;
      animation: popIn 0.5s ease-out;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
    }
    .modal-box h2 {
      margin-bottom: 10px;
      font-size: 24px;
    }
    .modal-box input {
      padding: 10px;
      width: 100%;
      border-radius: 12px;
      border: 1px solid #ccc;
      margin: 12px 0;
      font-size: 16px;
    }
    .modal-box button {
      background: linear-gradient(to right, #f58faf, #ffa8c6);
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 999px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    /* .modal-box button:hover {
      transform: scale(1.05);
    } */
    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    #result {       /* æŠ½ä¸­çµæœæ›´é†’ç›® */
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      margin: 16px 0;
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      background: linear-gradient(to right, #01ac6d, #5a8608);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(255,255,255,0.4);  
    }
  
    #drawTime {
      color: gray;
      font-size: 16px;
      text-align: center;
      font-family: 'Courier New', monospace;
    }
    .note {
      margin-top: 20px;
      font-size: 18px;
      color: #cc2222;
      text-align: center;
      line-height: 1.5;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      font-weight: bold;
    }
    #mainButton {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #eb7aa1, #ee97b5); 
      font-size: 30px;
      display: block;              
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 999px;             /* å¤§åœ“è§’ */
      margin: 20px auto;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);  /* é™°å½± */
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    /* #mainButton:hover {
      transform: scale(1.03);
    } */
    #mainButton:active {
      transform: scale(0.97);
    }
    #history-area {
      margin-top: 24px;
      background: rgba(255, 255, 255, 0.2);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    #result.error {
      color: #f85951;
      font-weight: bold;
      font-size: 36px;
      text-shadow: none;
    }
    #nameModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.15); /* æ·ºç™½é€æ˜èƒŒæ™¯ */
      backdrop-filter: blur(12px);          /* æ ¸å¿ƒæ‰“éœ§æ•ˆæœ */
      -webkit-backdrop-filter: blur(12px);  /* Safari */
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #online-list {    
      list-style: disc inside; /* é¡¯ç¤ºé»‘é»åœ¨æ–‡å­—å‰æ–¹ */
      padding-left: 16px;       /* ç•™ä¸€é»ç©ºé–“è®“é»‘é»èƒ½é¡¯ç¤º */
    }
    #online-list li {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      font-size: 22px;
      color: #4c3855;
      font-weight: 500;
      padding: 4px 0;
      width: 100%; 
      margin-left: 8px;
    }
    .history-entry {
      display: grid;
      grid-template-columns: max-content 1fr max-content;
      gap: 8px;
      align-items: start;
      padding: 6px 0;
      font-size: 22px;
      border-bottom: 1px dashed #e3c7e7;
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      width: 100%; 
    }

    .user-label {
      color: #555;
      font-weight: 500;
      white-space: nowrap;
    }

    .result-part {
      font-weight: 600;
      color: #333;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .time-part {
      color: #888;
      white-space: nowrap;
      font-family: monospace;
      font-size: 16px;
    }

    .switch-user-button {
      font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #f99ab8, #fbbbce);
      color: white;
      font-weight: bold;
      font-size: 24px;
      border: none;
      border-radius: 999px;
      padding: 14px 28px;
      width: 100%;
      margin: 24px auto;
      display: block;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    /* .switch-user-button:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    } */
    .switch-user-button:active {
      transform: scale(0.97);
    }
    .user-info-area {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-top: 16px;
    }

    .current-user-text {
      margin-top: 6px;
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }
    .disabled-button {
      opacity: 0.4;
      pointer-events: none;     /* ç¦ç”¨é»æ“Š */
      transform: none !important; /* é˜²æ­¢ hover/active æœ‰ç¸®æ”¾ */
      box-shadow: none !important;
      transition: none !important;
      animation: none !important;
    }
    .draw-control-button {
      padding: 8px 16px;  /* é«˜åº¦ä¸€è‡´ */
      font-size: 24px;
      border: none;
      border-radius: 999px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* --------for travel-------- */
    .title-row{
      display: flex;
      justify-content: center;   /* æ•´åˆ—ç½®ä¸­ */
      align-items: center;       /* å‚ç›´å°é½Š */
      gap: 20px;                 /* å­—è·ŸæŒ‰éˆ•ç•™ç©º */
      flex-wrap: wrap;           /* æ‰‹æ©Ÿçª„è¢å¹•æ™‚è‡ªå‹•æ›è¡Œ */
    }

    /* çµ¦é€™é¡†æŒ‰éˆ•å°ä¸€é»ã€é¡è‰²ä¸€è‡´ */
    .travel-btn{
      /* padding: 8px 22px; */
      font-size: 30px;
      background: linear-gradient(to right,#82d1f9,#7ceeda);
      box-shadow: 0 4px 10px rgba(0,0,0,.1);
      width: auto;               /* ä¸è¦æ»¿ç‰ˆ */
      margin-top: 40px;
    }
    /* ------------for tarvel--------------- */
    @media (max-width: 480px) {
      .travel-btn{ font-size:20px; padding:6px 16px; }
      h1, h2 {
        font-size: 20px;
        text-align: center;
      }
      .option-item {
        font-size: 18px;
      }
      .delete-btn {
        font-size: 18px;
      }
    }
    

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
      }
    }
    @keyframes pop {
      0%   { transform: scale(0.8); opacity: 0; }
      60%  { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }

    #result.show {
      animation: pop 0.4s ease-out;
    }

    
  </style>
</head>
<!-- made by waligach in June 2025 -->
<body>
  <div id="nameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999;">
    <div style="background: rgba(255, 255, 255, 0.855); padding: 24px 32px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center;">
      <h1 style="margin-bottom: 12px;"> å—¨ï¼ä½ æ˜¯èª°ï¼Ÿ</h1>
      <input id="nameInput" type="text" placeholder="ä½ å«å•¥ä¾†è‘—" style="padding: 12px; font-size: 18px; width: 100%; border-radius: 8px; border: 1px solid #ccc;">
      <button onclick="saveUserName()" style="margin-top: 16px; padding: 10px 16px; font-size: 20px; border: none;font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; border-radius: 8px; background: #ff85b2; color: white; cursor: pointer;">
        å¿ä¸ä½è¦é€²å»äº† ><
      </button>
      <div class="note">â€» äº‚å¡«è®“æˆ‘èªéŒ¯äººçš„ æˆ‘ä¸€å®šæœ‰è¾¦æ³•æ‰¾åˆ°ä½  ğŸ« </div>
    </div>
  </div>
  
  <div class="container">
    <div class="title-row">
      <h1>æ¬¸è¦åƒä»€éº¼ï¼Ÿ</h1>
      <button id="travelBtn"
              class="fancy-button travel-btn"
              onclick="location.href='/travel'">
              <img src="{{ url_for('static', filename='korea.png') }}" alt="korea" style="width: 25px; height: auto;">
      </button>
    </div>
    <!-- <h1>æ¬¸è¦åƒä»€éº¼ï¼Ÿ</h1>
    <button class="fancy-button draw-control-button"
        style="background: linear-gradient(to right,#82d1f9,#7ceeda);"
        onclick="location.href='/travel'">
        æ—…éŠæ™‚é–“è¡¨
    </button> -->
     <!-- â˜… çœ‹å“ªè£¡èƒ½ç”¨ -->
    <img src="{{ url_for('static', filename='random.png') }}" alt="random">
    <br>
    <div>
      <input id="newOption" type="text" placeholder="åŠ å€‹é¸é …">
      <button class="fancy-button" onclick="addOption()">â•ï¸åŠ é€²é¸é …å§ ~</button>
      <button class="fancy-button" onclick="confirmReset()" >ğŸ”„å…¨éƒ¨é‡è¨­ !</button>
    </div>

    <h2 class="gradient-title" >ç›®å‰é¸é …ï¼š</h2>
    <ul id="optionList"></ul>
    <div class="draw-controls" style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin: 16px 0;">
      <button id="quickDrawBtn" onclick="quickDraw()" class="fancy-button draw-control-button" style=" background: linear-gradient(to right, #e5c062eb, #efbe42dd); ">âš¡ï¸å¿«é€ŸæŠ½</button>
      <button id="mainButton" class="fancy-button" onclick="draw()">ğŸ²å¹«æˆ‘é¸å§ !!</button>
      <button onclick="toggleLock()" id="lockBtn" class="fancy-button draw-control-button" style=" background: linear-gradient(to right, #a4a1e4f1, #9690e7ee); ">ğŸ”’é–å®š</button>
    </div>
    <p id="loadingText" style="display:none; text-align:center; font-size:24px; color:#888;"></p>
    <h2 id="result" >æˆ‘ä¾†å¹«ä½ é¸ ! </h2>
    <p id="drawTime" style="color: gray; font-size: 16px;"></p>
    <div id="history-area" style="margin-top: 20px;">
      <h2 class="gradient-title">æŠ½é¸ç´€éŒ„ ( è¿‘äº”ç­† ):</h2>
      <ul id="history-list" style="padding-left: 0;"></ul>
    </div>
    <div class="user-info-area">
      <button  id="resetUserBtn" class="switch-user-button" onclick="resetUser()">æ›´æ›ä½¿ç”¨è€…</button>
      <span id="currentUserDisplay" class="current-user-text"></span>
    </div>
    
    <div id="online-area" style="margin-top:24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #dd9de1; padding-bottom: 4px; margin-bottom: 12px;">
        <!-- å–æ¶ˆåº•ç·šè‡ªå·±ç•« -->
        <h2 class="gradient-title" style="margin: 0;border-bottom: none;">ç¾åœ¨åœ¨ç·š ( <span id="online-count">0</span> )</h2> 
        <button onclick="addOnlineUsersToOptions()" 
                class="fancy-button"
                style="font-size: 16px; padding: 6px 16px; width: auto; max-width: 160px; white-space: nowrap; background: linear-gradient(to right, #d355e9dd, #6fb0eddf); ">
          ğŸ‘¥ åŠ é€²é¸é …
        </button>
      </div>

      <ul id="online-list" style="padding-left:0;"></ul>
    </div>
    <h4 style="color:rgba(176, 175, 175, 0.889);font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; text-align: center;"> â˜… made by waligach in June 2025 </h4>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();     //  ä¸€é–‹å§‹å°±é€£ç·š
    </script>
    <script>
      
      //---- login user
      // 2.å„²å­˜åç¨±ä¸¦é—œé–‰ç™»å…¥æ¡†
      function saveUserName() {
        const nameInput = document.getElementById("nameInput").value.trim();
        if (!nameInput) {
          alert("è«‹è¼¸å…¥åç¨±ï¼");
          return;
        }
        // localStorage.setItem("userName", nameInput); //å…ˆä¸å­˜ ç­‰å€™ç«¯æª¢æŸ¥é‡è¤‡
        document.getElementById("resetUserBtn").textContent = `æ›´æ›ä½¿ç”¨è€…ï¼ˆ æ³¥ç¾åœ¨æ˜¯ ${nameInput} ï¼‰`;
        document.getElementById("nameModal").style.display = "none";
        socket.emit("register", nameInput);//3.ä¸Ÿåˆ°å¾Œé¢æª¢æŸ¥é‡è¤‡ æœƒå›å¾©fail or ok
      }
      //4.1 å¾Œç«¯å›fail
      socket.on("register_failed", data => {//check same name
        alert(data.error);              // åç¨±é‡è¤‡
        // localStorage.removeItem("userName");
        document.getElementById("nameModal").style.display = "flex";
        document.getElementById("nameInput").focus();
      });
      //4.2 å¾Œç«¯å›ok å­˜
      socket.on("register_ok", username => {   // backendå¤šé€é€™å€‹äº‹ä»¶ ok æ‰å­˜
        localStorage.setItem("userName", username);
        document.getElementById("resetUserBtn").textContent =
            `æ›´æ›ä½¿ç”¨è€…ï¼ˆ æ³¥ç¾åœ¨æ˜¯ ${username} ï¼‰`;
        document.getElementById("nameModal").style.display = "none";
      });

      socket.on("user_list", users => {//list user
        const countEl = document.getElementById("online-count");
        const listEl  = document.getElementById("online-list");
        countEl.textContent = users.length;
        listEl.innerHTML = "";
        users.forEach(name => {
          const li = document.createElement("li");
          li.textContent = name;
          li.style.padding = "4px 0";
          listEl.appendChild(li);
        });
      });
      // 1.ç¶²é è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ è·³è¦–çª—å•
      window.addEventListener("DOMContentLoaded", () => {
        const saved = localStorage.getItem("userName");
        if (!saved) {//local æ²’å­˜é ç­‰è¼¸å…¥
          document.getElementById("nameModal").style.display = "flex";
        } else {//local æœ‰å­˜éäº† ç›´æ¥ä¸Ÿå¾Œé¢æª¢æŸ¥
          document.getElementById("resetUserBtn").textContent = `æ›´æ›ä½¿ç”¨è€…ï¼ˆ æ³¥ç¾åœ¨æ˜¯ ${saved} ï¼‰`;
          socket.emit("register", saved); //3.ä¸Ÿåˆ°å¾Œé¢æª¢æŸ¥é‡è¤‡ æœƒå›å¾©fail or ok
        }

        const input = document.getElementById("nameInput");// è®“æŒ‰ä¸‹ Enter å¯ä»¥è§¸ç™¼ç™»å…¥
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            saveUserName(); // 2.é€é saveUserName() æŠŠå‰›è¼¸å…¥çš„åå­—é€å»å¾Œç«¯
          }
        });
      });
      
      //document.getElementById("resetUserBtn").textContent = `æ›´æ›ä½¿ç”¨è€…ï¼ˆ æ³¥ç¾åœ¨æ˜¯ ${saved} ï¼‰`;// é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸Š
      // æ›´æ›ä½¿ç”¨è€…çš„æŒ‰éˆ•
      function resetUser() {
        localStorage.removeItem("userName");
        location.reload(); // é‡æ–°æ•´ç†å¾Œ åˆªä¹‹å‰åå­— å†é‡æ–°è©¢å•åå­—
      }
      //-------------------------
      
      function confirmReset() { //reset warning 
        const confirmed = confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¸é …å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼");
        if (confirmed) { 
          reset();  // å‘¼å«åŸæœ¬çš„ reset()
        }
      }
      let lastVersion = null;
      const historyList = [];

      async function syncStatus(dataFromCheck = null) {
        const data = dataFromCheck || await (await fetch("/status")).json();

        const resultEl = document.getElementById("result");
        const timeEl = document.getElementById("drawTime");

        resultEl.textContent = data.result ? `æŠ½ä¸­ï¼š${data.result}` : "æˆ‘ä¾†å¹«ä½ é¸ !!";
        timeEl.textContent = data.time ? `æŠ½å–æ™‚é–“ï¼š${data.time}` : "";

        const list = document.getElementById("optionList");
        list.innerHTML = "";
        (data.options || []).forEach((opt, index) => {
          const li = document.createElement("li");
          li.className = "option-item";

          const idx = document.createElement("span");
          idx.className = "index-label";
          idx.textContent = `${index + 1}.`;

          const span = document.createElement("span");
          span.textContent = opt;
          span.className = "option-text";

          const x = document.createElement("button");
          x.textContent = "âŒ";
          x.className = "delete-btn";
          x.onclick = async () => {
            await fetch("/remove_option", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ option: opt })
            });
          };

          li.appendChild(idx);
          li.appendChild(span);
          li.appendChild(x);
          list.appendChild(li);
        });

        window.currentOptions = data.options;
      }

      async function addOption() {
        const input = document.getElementById("newOption");
        const value = input.value.trim();
        if (!value) return;
        if ((window.currentOptions || []).includes(value)) {
          alert("æ…¢äº† åˆ¥äººå¡«äº†ï¼");
          input.value = "";
          return;
        }
        await fetch("/add_option", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ option: value })
        });
        input.value = "";
      }

      document.getElementById("newOption").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          addOption();
        }
      });

      async function draw() {
        if (drawLocked) {
          // alert("æŠ½çå·²é–å®šï¼");
          return;
        }
        
        const userName = localStorage.getItem("userName");//user id

        const resultEl = document.getElementById("result");
        const timeEl = document.getElementById("drawTime");
        const loadingText = document.getElementById("loadingText");
        //precheck isempty no option
        const check = await fetch("/status");
        const dataCheck = await check.json();
        if (!dataCheck.options || dataCheck.options.length === 0) {
          resultEl.textContent = "æ²’é¸é …ä½ æƒ³æŠ½å•¥ ?";
          resultEl.classList.add("error");  // åŠ ä¸Šç´…è‰²æ¨£å¼
          resultEl.style.display = "block";
          return;
        }else {
          resultEl.classList.remove("error")
        }
        // é¡¯ç¤º loading æ–‡å­—ï¼Œéš±è—çµæœ
        resultEl.style.display = "none";
        loadingText.style.display = "block";
        timeEl.textContent = "";
        
        loadingText.textContent = "æº–å‚™ä¸­...";
        const phrases = [
          "é¸æ“‡å›°é›£ä¸­ ç­‰æˆ‘...",
          "æ­£åœ¨å«å³æ¾¤æ¨ºèµ·åºŠ...",
          "ç­‰å¾…åˆ¥äººçµ¦æˆ‘è®šè³...",
          "æŠ½å®Œä¸è¦åˆå¾Œæ‚”å–”...",
          "ä¸è¦ºå¾—é€™æ¨£å¾ˆå¥½ç©å—...",
          "æ‹œè¨—çµ¦é»æƒ…ç·’åƒ¹å€¼...",
          "å¥½å•¦çœŸçš„è¦æŠ½äº† ! ! !"
        ];
        // è¼ªæµæ›´æ–°æ–‡å­—
        loadingIndex = 0;
        loadingTimer = setInterval(() => {
          loadingText.textContent = phrases[loadingIndex % phrases.length];
          loadingIndex++;
        }, 800); 
        // ç­‰ç§’ï¼ˆæ¨¡æ“¬æŠ½çï¼‰
        await new Promise(resolve => setTimeout(resolve, 6000));
        //ç™¼å‡ºè«‹æ±‚
        const res = await fetch("/draw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: userName })
        });
        const data = await res.json();
        // çµæœé¡¯ç¤º
        clearInterval(loadingTimer); // åœæ­¢è¼ªæ’­
        loadingText.style.display = "none";
        resultEl.style.display = "block";

        if (data.result) {
          resultEl.textContent = `æŠ½ä¸­ï¼š${data.result}`;
          timeEl.textContent = `æŠ½å–æ™‚é–“ï¼š${data.time}`;

          resultEl.classList.remove("show"); // å…ˆç§»é™¤å†é‡æ–°åŠ 
          void resultEl.offsetWidth; // force reflow
          resultEl.classList.add("show");
        } else {
          resultEl.textContent = data.error || "éŒ¯èª¤";
          timeEl.textContent = "";
        }
      }
      //--------------two btn
      let drawLocked = false;

      function toggleLock() {
        drawLocked = !drawLocked;
        const lockBtn = document.getElementById("lockBtn");
        const mainBtn = document.getElementById("mainButton");
        const quickBtn = document.getElementById("quickDrawBtn");

        lockBtn.textContent = drawLocked ? "ğŸ”’è§£é–" : "é–å®š";
        
        if (drawLocked) {
          mainBtn.classList.add("disabled-button");
          quickBtn.classList.add("disabled-button");
        } else {
          mainBtn.classList.remove("disabled-button");
          quickBtn.classList.remove("disabled-button");
        }
      }
      async function quickDraw() {
        
        if (drawLocked) {
          // alert("æŠ½çå·²é–å®šï¼");
          return;
        }
        const userName = localStorage.getItem("userName") ;
        const resultEl = document.getElementById("result");
        const timeEl = document.getElementById("drawTime");
        const check = await fetch("/status");
        const dataCheck = await check.json();
        if (!dataCheck.options || dataCheck.options.length === 0) {
          resultEl.textContent = "æ²’é¸é …ä½ æƒ³æŠ½å•¥ ?";
          resultEl.classList.add("error");
          resultEl.style.display = "block";
          return;
        }else {
          resultEl.classList.remove("error")
        }
        const res = await fetch("/draw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: userName })
        });
        const data = await res.json();
        if (data.result) {
          resultEl.textContent = `æŠ½ä¸­ï¼š${data.result}`;
          timeEl.textContent = `æŠ½å–æ™‚é–“ï¼š${data.time}`;
          resultEl.classList.remove("show");
          void resultEl.offsetWidth;
          resultEl.classList.add("show");
        } else {
          resultEl.textContent = data.error || "éŒ¯èª¤";
          timeEl.textContent = "";
        }
      }
      //--------quick draw end----user2option ------------
      async function addOnlineUsersToOptions() {
        await fetch("/reset_options", { method: "POST" }); //clear
        // å†æŠ“ç›®å‰åœ¨ç·šä½¿ç”¨è€…
        const listItems = document.querySelectorAll("#online-list li");
        const usernames = Array.from(listItems).map(li => li.textContent.trim());
        // å°‡æ¯ä½ä½¿ç”¨è€…åŠ é€²é¸é …
        for (const name of usernames) {
          await fetch("/add_option", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ option: name })
          });
        }
      }
      //------user2option end------
      async function reset() {
        await fetch("/reset_options", { method: "POST" });
      }


      function updateHistoryDisplay() {
        const ul = document.getElementById("history-list");
        ul.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
        historyList.forEach(item => {
          const li = document.createElement("li");
          li.className = "history-entry";

          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.listStyle = "none";
          const userSpan = document.createElement("span");
          userSpan.className = "user-label";
          userSpan.textContent = `${item.user} æŠ½ä¸­ï¼š`;

          const resultSpan = document.createElement("span");
          resultSpan.className = "result-part";
          resultSpan.textContent = item.result;

          const timeSpan = document.createElement("span");
          timeSpan.className = "time-part";
          timeSpan.textContent = `æ™‚é–“ï¼š${item.time}`;
          timeSpan.style.color = "gray";
          
          li.appendChild(userSpan);
          li.appendChild(resultSpan);
          li.appendChild(timeSpan);
          ul.appendChild(li);
        });
      }
      
      async function loadHistory() {
      const res = await fetch("/history");
      const data = await res.json();
      historyList.length = 0;
      historyList.push(...data);
      updateHistoryDisplay(); 
      }
      loadHistory();
      syncStatus();


      socket.on("connect", () => {
        console.log("WebSocket å·²é€£ç·š");
      });

      socket.on("history_update", (data) => {
        console.log("æ”¶åˆ°æ­·å²ç´€éŒ„æ›´æ–°ï¼š", data);
        historyList.length = 0;
        historyList.push(...data);
        updateHistoryDisplay();
      });
      socket.on("status_update", (data) => {
        console.log("æ”¶åˆ°æœ€æ–°ç‹€æ…‹ï¼š", data);
        syncStatus(data);  // ç›´æ¥å‘¼å«åŸæœ¬è™•ç†é‚è¼¯
      });
      
    </script>
  </div>
  <!-- <h2> made by waligach in June 2025 </h2> -->
</body>
</html>
